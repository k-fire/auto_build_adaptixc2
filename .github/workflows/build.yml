name: Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:9

    steps:
    - name: Use Debian 9 official archive sources
      run: |
        echo "deb http://archive.debian.org/debian stretch main contrib non-free" > /etc/apt/sources.list
        echo "deb http://archive.debian.org/debian-security stretch/updates main contrib non-free" >> /etc/apt/sources.list
        echo 'Acquire::Check-Valid-Until "false";' > /etc/apt/apt.conf.d/99no-check-valid-until
        apt-get update

    - name: Install dependencies (including sudo)
      run: |
        apt-get install -y sudo git curl tar gcc make cmake libssl-dev libc6-dev

    - name: Install Go 1.24.3
      run: |
        curl -LO https://go.dev/dl/go1.24.3.linux-amd64.tar.gz
        tar -C /usr/local -xzf go1.24.3.linux-amd64.tar.gz
        echo "export PATH=$PATH:/usr/local/go/bin" >> /etc/profile
        export PATH=$PATH:/usr/local/go/bin
        go version


    - name: Clone AdaptixC2 and run pre-install
      run: |
        git clone https://github.com/Adaptix-Framework/AdaptixC2.git


    - name: Build server and extenders
      run: |
        export PATH=$PATH:/usr/local/go/bin
        cd AdaptixC2
        make server
        make extenders

    - name: Print glibc version
      run: |
        ldd --version | head -n 1

    - name: Package dist folder
      run: |
        cd AdaptixC2/dist
        tar -czf adaptixc2_build.tar.gz *

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: adaptixc2_build
        path: AdaptixC2/dist/adaptixc2_build.tar.gz
